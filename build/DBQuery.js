var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _lodash=require("lodash");var _rhsCommon=require("rhs-common");var _DBCommon=require("./DBCommon");function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}var isNull=_rhsCommon.PureFunctions.isNull,isJSONObject=_rhsCommon.PureFunctions.isJSONObject,getMergedFilter=_rhsCommon.PureFunctions.getMergedFilter,resolveValue=_rhsCommon.PureFunctions.resolveValue,getNullOrObject=_rhsCommon.PureFunctions.getNullOrObject,getRequiredParamValue=_rhsCommon.PureFunctions.getRequiredParamValue,getNestedFields=_rhsCommon.PureFunctions.getNestedFields,getSchema=_rhsCommon.PureFunctions.getSchema,getRelations=_rhsCommon.PureFunctions.getRelations,getSubQueries=_rhsCommon.PureFunctions.getSubQueries,getSubModels=_rhsCommon.PureFunctions.getSubModels,getSubModelObjects=_rhsCommon.PureFunctions.getSubModelObjects,getReferenceFields=_rhsCommon.PureFunctions.getReferenceFields,getIdFilter=_rhsCommon.PureFunctions.getIdFilter,getComputations=_rhsCommon.PureFunctions.getComputations,computeRecursively=_rhsCommon.PureFunctions.computeRecursively,getRelationFilterPipeline=_rhsCommon.PureFunctions.getRelationFilterPipeline,getJoinFilter=_rhsCommon.PureFunctions.getJoinFilter,getJoinFilterOneByOne=_rhsCommon.PureFunctions.getJoinFilterOneByOne,isReferenceField=_rhsCommon.PureFunctions.isReferenceField,deepClone=_rhsCommon.PureFunctions.deepClone,isNativeSort=_rhsCommon.PureFunctions.isNativeSort,getMemorySort=_rhsCommon.PureFunctions.getMemorySort,getNativeSort=_rhsCommon.PureFunctions.getNativeSort;var GROUP_BY_CHILDREN="_children";var addAggregate=function addAggregate(aggregates,aggregatesFields,pKey,pValue){for(var key in aggregates){var fieldValue=aggregates[key];var field=key;var value=key;if(pKey){field=pKey+"_"+key;value=pValue+"."+value;}if(fieldValue===1){aggregatesFields[field]={$sum:field==="_count"?1:"$"+value};}else if(fieldValue==="sum"||fieldValue==="avg"||fieldValue==="min"||fieldValue==="max"||fieldValue==="first"||fieldValue==="last"){var operator="$"+fieldValue;aggregatesFields[field]={};aggregatesFields[field][operator]="$"+value;}else if(fieldValue==="count"){aggregatesFields[field]={$sum:1};}else if(isJSONObject(fieldValue)){if(resolveValue(fieldValue,"$sum")||resolveValue(fieldValue,"$avg")||resolveValue(fieldValue,"$min")||resolveValue(fieldValue,"$max")){if(pKey){throw new Error("Invalid value >> "+fieldValue+" of field "+field+" of parent field "+pKey+" in aggregate.");}else{aggregatesFields[field]=fieldValue;}}else{addAggregate(fieldValue,aggregatesFields,field,value);}}}};var resolveGroup=function resolveGroup(_ref){var group=_ref.group,aggregates=_ref.aggregates;if(aggregates){var aggregatesFields={};addAggregate(aggregates,aggregatesFields);var _id=group&&typeof group=="string"?"$"+group:null;group=_extends({_id:_id},aggregatesFields);}return group;};var generateAggregatePipeline=function generateAggregatePipeline(query){var filter=query.filter,fields=query.fields,unwind=query.unwind,group=query.group,sort=query.sort,groupSort=query.groupSort,limit=query.limit,skip=query.skip;var pipeline=[];if(filter&&Object.keys(filter).length>0){pipeline.push({$match:filter});}if(unwind){resolveUnwind({filter:filter,unwind:unwind,pipeline:pipeline});}if(sort&&(!group||isJSONObject(group)&&group[GROUP_BY_CHILDREN]||Array.isArray(group)&&group.length>0&&group[0][GROUP_BY_CHILDREN])){pipeline.push({$sort:sort});}if(!group){if(fields&&Object.keys(fields).length>0){pipeline.push({$project:fields});}}else{if(Array.isArray(group)){for(var _iterator=group,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref2;if(_isArray){if(_i>=_iterator.length)break;_ref2=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref2=_i.value;}var grp=_ref2;pipeline.push({$group:grp});}}else{pipeline.push({$group:group});}}if(groupSort){pipeline.push({$sort:groupSort});}if(skip){pipeline.push({$skip:skip});}if(limit){pipeline.push({$limit:limit});}return pipeline;};var resolveUnwind=function resolveUnwind(_ref3){var filter=_ref3.filter,unwind=_ref3.unwind,pipeline=_ref3.pipeline,pKey=_ref3.pKey;for(var obj in unwind){var objValue=unwind[obj];var field=obj;if(pKey){field=pKey+"."+obj;}if(objValue===1){pipeline.push({$unwind:"$"+field});if(filter){pipeline.push({$match:filter});}}else if(isJSONObject(objValue)){pipeline.push({$unwind:"$"+field});if(filter){pipeline.push({$match:filter});}resolveUnwind({filter:filter,unwind:objValue,pipeline:pipeline,pKey:field});}else{throw new Error("Invalid value >> "+objValue+" of field "+obj+" in unwind.");}}};var joinRelationData=function joinRelationData(params,result,refResult,field,relationInfo,aggregates,refModel){if(!result||!result.length){return;}var refData=refResult.result,_metadata=refResult._metadata;var reference=relationInfo.reference,self=relationInfo.self;var referenceField=isReferenceField(refModel,reference)?reference+"._id":reference;var refMap=refData&&refData.reduce(function(accum,current){if(aggregates){var refId=resolveValue(current,"_id");accum[refId]=current;}else{var _refId=resolveValue(current,referenceField);accum[_refId]=accum[_refId]||[];accum[_refId].push(current);var recursive=relationInfo.recursive;if(recursive&&recursive!=="hierarchy"){var recursiveData=current[field];delete current[field];if(recursiveData){recursiveData.forEach(function(rec){return accum[_refId].push(rec);});}}}return accum;},{});params["_metadata"]=params["_metadata"]||{};params["_metadata"][field]=_metadata;result.forEach(function(doc){return doc[field]=refMap[resolveValue(doc,self)];});};var getFindDoc=function getFindDoc(data,doc){var docId=doc&&doc._id;var value=data&&docId&&data.find(function(_doc){return _doc._id===docId||_doc._id.equals(docId);});return value||doc;};var joinReferenceData=function joinReferenceData(result,refData,field){if(!refData){return;}result.forEach(function(doc){var refValue=doc[field];if(refValue){if(Array.isArray(refValue)){doc[field]=refValue.map(function(_refValue){return getFindDoc(refData,_refValue);});}else{doc[field]=getFindDoc(refData,refValue);}}});};var joinReferenceDataPipeline=function joinReferenceDataPipeline(params,pipeline,schema,subModels){var result=params.result,referenceFields=params.referenceFields,args=params.args;if(!referenceFields||!result||!result.length){return params;}Object.keys(referenceFields).forEach(function(field){var refQueryFields=referenceFields[field];var subModel=subModels&&subModels[field];if(field===GROUP_BY_CHILDREN){joinReferenceDataPipeline({result:resolveValue(result,field),referenceFields:refQueryFields},pipeline,schema,subModels);}else if(subModel){var subModelSchema=subModel._schema;var fieldSubModels=getSubModels(subModelSchema);joinReferenceDataPipeline({result:resolveValue(result,field),referenceFields:refQueryFields},pipeline,subModelSchema,fieldSubModels);}else{var referenceField=field+"._id";var refIds=resolveValue(result,referenceField);if(!refIds.length){return;}var refIdMap={};refIds=refIds.filter(function(refId){if(!refIdMap[refId]){refIdMap[refId]=1;return true;}});var refModel=(0,_DBCommon.getReferenceModel)(field,schema);var query=_rhsCommon.Query.of().fields(refQueryFields).filter(getIdFilter(refIds));pipeline.add(function(){return find(refModel,query,args);},function(params,refData){return joinReferenceData(result,refData.result,field);});}});return pipeline;};var ensureJoinRequiredFields=function ensureJoinRequiredFields(joinQuery,relationInfo,field){var reference=relationInfo.reference,recursive=relationInfo.recursive;var refQueryFields=joinQuery._fields;var fieldsToEnsure={};if(!refQueryFields[reference]){fieldsToEnsure[reference]=1;}if(recursive&&!refQueryFields[field]){fieldsToEnsure[field]=_extends({},refQueryFields);}if(getNullOrObject(fieldsToEnsure)){joinQuery=joinQuery.addFields(fieldsToEnsure);}return joinQuery;};var mergeJoinQuery=function mergeJoinQuery(joinQuery,relationFilter,paramValue){var refQuery=joinQuery.addFilter(relationFilter);if(paramValue){refQuery=refQuery.paramValue(paramValue);}return refQuery;};var joinDataPipeline=function joinDataPipeline(params,pipeline,schema,field,fieldInfo,joinQuery,relationInfo,refModel,references,relations,nestedType){var result=params.result,paramValue=params.paramValue,requiredParamValue=params.requiredParamValue,user=params.user,args=params.args;if(!result||!result.length){return pipeline;}var _relationInfo=relationInfo,reference=_relationInfo.reference,_relationInfo$self=_relationInfo.self,self=_relationInfo$self===undefined?"_id":_relationInfo$self;var isOneByOne=isResolveOneByOne(joinQuery,fieldInfo,schema,refModel,relationInfo,relations);if(self!=="_id"&&typeof self==="string"&&(references&&references[self]||relations&&relations[self])){self=self+"._id";}relationInfo=_extends({},relationInfo,{self:self});var _aggregates=joinQuery._aggregates;var joinAdditionalParams={paramValue:requiredParamValue,user:user};if(isOneByOne){result.forEach(function(row,index){var joinParams=_extends({data:row},joinAdditionalParams);var relationFilter=getJoinFilterOneByOne(joinParams,refModel,relationInfo);if(!relationFilter){return;}pipeline.add(function(){var joinQueryParamValue=relationInfo.paramValue?relationInfo.paramValue(joinParams):paramValue;if(fieldInfo&&fieldInfo._invoke){var invokeInfo=fieldInfo._invoke;var invokeParamValue=invokeInfo.paramValue;if(invokeParamValue&&typeof invokeParamValue==="function"){invokeParamValue=invokeParamValue(_extends({},joinParams,{paramValue:joinQueryParamValue}));}return(0,_DBCommon.invoke)(invokeInfo.name,invokeParamValue||{});}else{var refQuery=mergeJoinQuery(joinQuery,relationFilter,joinQueryParamValue);if(nestedType&&nestedType==="subQuery"){var _subQueryInfo=deepClone(refQuery);_subQueryInfo.subQueryField=field;if(_aggregates){_subQueryInfo.fieldAggregates=deepClone(_aggregates);}_subQueryInfo["query_required"]=true;params["_subQueriesInfo"]=params["_subQueriesInfo"]||[];params["_subQueriesInfo"].push(_subQueryInfo);}if(_aggregates){refQuery=refQuery.only();}return find(refModel,refQuery,args);}},function(_,refData){row[field]=refData.result;params["_metadata"]=params["_metadata"]||{};params["_metadata"][field]=refData._metadata;});});}else{var relationFilter=getJoinFilter(_extends({data:result},joinAdditionalParams),refModel,relationInfo);if(!relationFilter){return;}pipeline.add(function(){var refQuery=mergeJoinQuery(joinQuery,relationFilter,paramValue);if(nestedType&&nestedType==="subQuery"){var isRef=isReferenceField(refModel,reference);var ids=isRef?relationFilter[reference]["_id"]["$in"]||relationFilter[reference]["_id"]:relationFilter[reference]["$in"]||relationFilter[reference];if(ids){var needToAddFilter=true;if(!Array.isArray(ids)){ids=[ids];needToAddFilter=false;}for(var _iterator2=ids,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref4;if(_isArray2){if(_i2>=_iterator2.length)break;_ref4=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref4=_i2.value;}var id=_ref4;var _subQueryInfo=deepClone(refQuery);if(needToAddFilter){if(isRef){_subQueryInfo=_subQueryInfo.addFilter(_defineProperty({},reference,{_id:id}));}else{_subQueryInfo=_subQueryInfo.addFilter(_defineProperty({},reference,id));}}_subQueryInfo.subQueryField=field;if(_aggregates){_subQueryInfo.fieldAggregates=deepClone(_aggregates);}_subQueryInfo["query_required"]=true;params["_subQueriesInfo"]=params["_subQueriesInfo"]||[];params["_subQueriesInfo"].push(_subQueryInfo);}}}if(_aggregates){var groupField=isReferenceField(refModel,reference)?reference+"._id":reference;refQuery=refQuery.group(groupField);}refQuery=ensureJoinRequiredFields(refQuery,relationInfo,field);return find(refModel,refQuery,args);},function(_,refResult){return joinRelationData(params,result,refResult,field,relationInfo,_aggregates,refModel);});}};var joinRelationDataPipeline=function joinRelationDataPipeline(params,schema,relations,references){var relationFields=params.relationFields,result=params.result;if(!relationFields||!result||!result.length){return params;}var pipeline=_rhsCommon.Pipeline.of("Db Connect - joinRelationDataPipeline").param(params);Object.keys(relationFields).forEach(function(field){var relationInfo=relations[field];var refModel=(0,_DBCommon.getReferenceModel)(field,schema);var joinQuery=getJoinQuery(relationFields[field]);joinDataPipeline(params,pipeline,schema,field,relationInfo,joinQuery,relationInfo,refModel,references,relations,"relation");});return pipeline;};var joinSubQueryDataPipeline=function joinSubQueryDataPipeline(params,pipeline,schema,subQueries,relations,references){var subQueryFields=params.subQueryFields,result=params.result,metadata=params.metadata;if(!subQueryFields||!result||!result.length){return params;}Object.keys(subQueryFields).forEach(function(field){if(field===GROUP_BY_CHILDREN){joinSubQueryDataPipeline(_extends({},params,{result:resolveValue(result,field),subQueryFields:subQueryFields[field]}),pipeline,schema,subQueries,relations,references);}else{var subQueryInfo=subQueries[field];var _relation=subQueryInfo._relation,_query=subQueryInfo._query,_when=subQueryInfo._when,_paramValue=subQueryInfo._paramValue;var relationInfo=relations&&relations[_relation];if(!relationInfo){throw new Error("relation not found for field "+_relation+" defined in subQuery "+field);}var refModel=(0,_DBCommon.getReferenceModel)(_relation,schema);var mainQuery=void 0;if(_query){var refQueries=refModel._queries;var refModelId=refModel._id;if(!refQueries){throw new Error("query ["+_query+"] defined in field ["+field+"] not found in model ["+refModelId+"]");}mainQuery=refQueries[_query];if(!mainQuery){throw new Error("query ["+_query+"] defined in field ["+field+"] not found in model ["+refModelId+"]");}if(typeof mainQuery=="function"){throw new Error("query ["+_query+"] defined in field ["+field+"] found in model ["+refModelId+"] can not be a function");}}var joinQuery=getJoinQuery(subQueryFields[field],mainQuery,subQueryInfo,metadata);relationInfo=_extends({},relationInfo);if(_when){relationInfo.when=_when;}if(_paramValue){relationInfo.paramValue=_paramValue;}joinDataPipeline(params,pipeline,schema,field,subQueryInfo,joinQuery,relationInfo,refModel,references,relations,"subQuery");}});return pipeline;};var getJoinQuery=function getJoinQuery(queryFields,mainQuery,subQueryInfo,metadata){var query=_rhsCommon.Query.of();if(mainQuery){if(!mainQuery._query){throw new Error("In Sub query, it should be instance of Query but not found >> it is "+JSON.stringify(mainQuery));}query=mainQuery.clone();}if(metadata){query=query.metadata(true);}if(subQueryInfo){if(subQueryInfo._query){query=query.id(subQueryInfo._query);}if(subQueryInfo._fields){query=query.fields(subQueryInfo._fields);}if(subQueryInfo._addFilter){query=query.addFilter(subQueryInfo._addFilter);}if(subQueryInfo._aggregates){query=query.aggregates(subQueryInfo._aggregates);}if(subQueryInfo._limit!==undefined){query=query.limit(subQueryInfo._limit);}if(subQueryInfo._sort!==undefined){query=query.sort(subQueryInfo._sort);}if(subQueryInfo._unwind!==undefined){query=query.unwind(subQueryInfo._unwind);}if(subQueryInfo._scalar!==undefined){query=query.scalar(subQueryInfo._scalar);}query=query.fieldAggregates(null);}if(queryFields!==1){query=query.fields(_extends({},queryFields));}if(!query._fields){query=query.fields({_id:1});}return query;};var isResolveOneByOne=function isResolveOneByOne(query,fieldInfo,schema,refModel,relationInfo,relations){var recursive=relationInfo.recursive,reference=relationInfo.reference,_relationInfo$self2=relationInfo.self,self=_relationInfo$self2===undefined?"_id":_relationInfo$self2,filter=relationInfo.filter,when=relationInfo.when,paramValue=relationInfo.paramValue;if(recursive){return false;}if(filter||isJSONObject(reference)||when||paramValue||relations&&relations[self]){return true;}if(fieldInfo&&fieldInfo._invoke||query._limit!==undefined||query._only){return true;}var refFieldSchema=refModel._schema[reference];if(Array.isArray(refFieldSchema)){return true;}if(self!=="_id"){var selfModel=schema[self];if(Array.isArray(selfModel)){return true;}}};var volatileDataPipeline=function volatileDataPipeline(param,model){var result=param.result,volatileFields=param.volatileFields;var computations=getComputations(model._computations);if(!volatileFields||!computations||!result||!result.length){return;}var pipeline=_rhsCommon.Pipeline.of("computation on query").param({});var volatileComputations={};var changeFields={};for(var fieldKey in volatileFields){var fieldComputation=computations[fieldKey];if(fieldComputation){var _onChange=fieldComputation._onChange;for(var change in _onChange){changeFields[change]=1;}volatileComputations[fieldKey]=fieldComputation;}}var _loop=function _loop(i){var data=result[i];pipeline.add(function(){return computeRecursively({model:model,data:data,changeFields:changeFields,computations:volatileComputations},find,_DBCommon.invoke);});};for(var i=0;i<result.length;i++){_loop(i);}return pipeline;};var validateFilter=function validateFilter(filter){var parent=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";if(isJSONObject(filter)){for(var k in filter){var filterValue=filter[k];if(filterValue===undefined){throw new Error("Filter value can not be undefined for key ["+k+"]");}else if(Array.isArray(filterValue)){filterValue.forEach(function(val){return validateFilter(val,parent+" -> "+k);});}else if(isJSONObject(filterValue)){validateFilter(filterValue,parent+" -> "+k);}}}};var modifyFilterPipeline=function modifyFilterPipeline(params,schema,separateSchema,model){var user=params.user,filter=params.filter,requiredParamValue=params.requiredParamValue,args=params.args;if(!filter){return params;}try{validateFilter(filter);}catch(e){throw new Error("Error in validate filter "+e.message+" >> Filter >>> ["+JSON.stringify(filter)+"] >>> Model ["+model._id+"]");}var pipeline=_rhsCommon.Pipeline.of("Db Connect - modifyFilter").param({});var modifiedFilter={};modifyFilter(params,modifiedFilter,filter,pipeline,schema,separateSchema,user,requiredParamValue,void 0,args);pipeline.add(function(){return{filter:modifiedFilter};});return pipeline;};var resolveFilterValue=function resolveFilterValue(params,filter,key,value,pipeline,schema,separateSchema,user,requiredParam,pKey,args){if(typeof value=="function"){value=value(requiredParam,user);}if(value&&value._invoke){var invokePipeline=_rhsCommon.Pipeline.of("Db Connect - invokeFunctionPipeline").param({});var invokeName=value._name;invokePipeline.add(function(){return(0,_DBCommon.invoke)(invokeName,value._param);},function(params,invokeResult){if(invokeResult){if(!invokeResult.hasOwnProperty(invokeName)){throw new Error("filter function for key ["+key+"] should return result in JSON object with invoke key name");}else{invokeResult=invokeResult[invokeName];}}if(invokeResult===undefined){delete filter[pKey?pKey+"."+key:key];}modifyFilter(params,filter,_defineProperty({},key,invokeResult),pipeline,schema,separateSchema,user,requiredParam,pKey,args);});pipeline.add(invokePipeline);return;}if(value===undefined||value===null){return value;}if(isJSONObject(value)){value=Object.keys(value).reduce(function(accum,current){var innerValue=value[current];if(current.indexOf("$")===0&&current!=="$exists"){innerValue=resolveFilterValue(params,{},key,innerValue,pipeline,schema,separateSchema,user,requiredParam,void 0,args);}accum[current]=innerValue;return accum;},{});}else if(Array.isArray(value)){value=value.map(function(_v){return resolveFilterValue(params,{},key,_v,pipeline,schema,separateSchema,user,requiredParam,void 0,args);});}else if(typeof value==="string"){var keySchema=schema[key];if(keySchema==="objectId"){value=(0,_DBCommon.getObjectId)(value);}else if(keySchema==="date"){value=new Date(value);}}return value;};var resolveReferenceFilterValue=function resolveReferenceFilterValue(param,key,value,pipeline,schema,relationInfo,args){var reference=relationInfo?relationInfo.reference:void 0;var valueKeys=isJSONObject(value)?Object.keys(value):[];var isDollerValue=valueKeys.length&&valueKeys[0].indexOf("$")===0;if(!valueKeys.length||reference&&isDollerValue){throw new Error("Invalid filter value for key "+key+" >>>>> value found >>>> "+JSON.stringify(value));}else if(isDollerValue){return value;}var refModel=(0,_DBCommon.getReferenceModel)(key,schema);if(reference||!value._id){var refIds=[];var refFilterPipeline=_rhsCommon.Pipeline.of("Db Connect - referenceFilterPipeline").param({});var queryFields={_id:1};var scalar="_id";if(reference&&reference!=="_id"){queryFields=_defineProperty({},reference,{_id:1});scalar=reference+"._id";}var query=_rhsCommon.Query.of().fields(queryFields).filter(value).scalar(scalar);if(relationInfo&&relationInfo.filter){if(typeof relationInfo.filter==="object"){query=query.addFilter(relationInfo.filter);}else if(typeof relationInfo.filter==="function"){throw Error("Filter can't be of function type in relation when relation field itself used as filter key, relationInfo is "+JSON.stringify(relationInfo)+" and key is "+key);}}refFilterPipeline.add(function(){return find(refModel,query,args);},function(params){var _ref5=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},result=_ref5.result;result&&result.forEach(function(row){refIds.push(row);});});pipeline.add(refFilterPipeline);value={$in:refIds};param["query_required"]=true;}else{value=resolveFilterValue(param,{},"_id",value._id,pipeline,refModel._schema,void 0,void 0,void 0,void 0,args);}return value;};var modifyFilter=function modifyFilter(params,newFilter,filter,pipeline,schema,separateSchema,user,requiredParam,pKey,args){var _ref6=separateSchema||{},references=_ref6.references,subModels=_ref6.subModels,relations=_ref6.relations,subQueries=_ref6.subQueries,subModelObjects=_ref6.subModelObjects;return filter&&Object.keys(filter).reduce(function(modifiedFilter,fKey){var indexOfDot=fKey.indexOf(".");if(indexOfDot>0){throw new Error("Dot is not allowed in filter for key "+fKey);}var requiredFilterKey=pKey?pKey+"."+fKey:fKey;var filterValue=filter[fKey];if(fKey==="$elemMatch"){modifiedFilter[pKey]=modifiedFilter[pKey]||{};modifiedFilter[pKey][fKey]=modifyFilter(params,{},filterValue,pipeline,schema,separateSchema,user,requiredParam,void 0,args);}else if(fKey==="$and"||fKey==="$or"){modifiedFilter[requiredFilterKey]=filterValue.map(function(innerFilterValue){return modifyFilter(params,{},innerFilterValue,pipeline,schema,separateSchema,user,requiredParam,void 0,args);});}else{filterValue=resolveFilterValue(params,modifiedFilter,fKey,filterValue,pipeline,schema,separateSchema,user,requiredParam,pKey,args);if(filterValue!==undefined&&filterValue!==null){if(references&&references[fKey]){filterValue=resolveReferenceFilterValue(params,fKey,filterValue,pipeline,schema,void 0,args);requiredFilterKey=requiredFilterKey+"._id";}else if(subModels&&subModels[fKey]||subModelObjects&&subModelObjects[fKey]){var subModel=subModels&&subModels[fKey];if(!subModel){subModel=subModelObjects[fKey];}var subModelSchema=subModel._schema;if(!isJSONObject(filterValue)){throw new Error("Invalid Filter Value for array field >>>>>> "+fKey+" >>>>>> value >>>>>> "+JSON.stringify(filterValue));}else{modifyFilter(params,modifiedFilter,filterValue,pipeline,subModelSchema,{references:getReferenceFields(subModelSchema),subModels:getSubModels(subModelSchema),subModelObjects:getSubModelObjects(subModelSchema),subQueries:getSubQueries(subModel),relations:getRelations(subModel)},user,requiredParam,requiredFilterKey,args);return modifiedFilter;}}else if(subQueries&&subQueries[fKey]||relations&&relations[fKey]){var relationInfo=relations&&relations[fKey];var subQueryInfo=subQueries&&subQueries[fKey];if(subQueryInfo){relationInfo=relations&&relations[subQueryInfo._relation];}var reference=relationInfo&&relationInfo.reference;if(!reference){throw new Error("filter not supported for nested field >>>>>> "+fKey+" >>>>>> value found >>>>>> "+JSON.stringify(filterValue));}params["query_required"]=true;filterValue=resolveReferenceFilterValue(params,fKey,filterValue,pipeline,schema,relationInfo,args);var _relationInfo2=relationInfo,_relationInfo2$self=_relationInfo2.self,self=_relationInfo2$self===undefined?"_id":_relationInfo2$self;if(self==="_id"){requiredFilterKey="_id";}else{requiredFilterKey=self+"._id";}}}if(filterValue!==undefined){modifiedFilter[requiredFilterKey]=filterValue;}}return modifiedFilter;},newFilter);};var separateGroups=function separateGroups(params,schema,references,relations,subQueries,subModels,groups){if(!groups){return;}if(Array.isArray(groups)&&groups.length>2){throw new Error("Invalid group value >> Maxmium 2 group support. Number of groups are > "+groups.length+"  in group array >>> "+groups);}var referenceFields={};var subQueryFields={};var firstLevelAggregateFields={};var groupSort=void 0;if(Array.isArray(groups)){groupSort=groups[0].sort;if(groups.length===1){separateGroupFields(params,schema,references,relations,subModels,subQueries,referenceFields,subQueryFields,groups[0]);}else{var firstLevelChildren=groups[0][GROUP_BY_CHILDREN];if(firstLevelChildren){var children=groups[1][GROUP_BY_CHILDREN];if(children[GROUP_BY_CHILDREN]){children[GROUP_BY_CHILDREN]=firstLevelChildren;}}separateGroupFields(params,schema,references,relations,subModels,subQueries,referenceFields,subQueryFields,groups[0],1,firstLevelAggregateFields);separateGroupFields(params,schema,references,relations,subModels,subQueries,referenceFields,subQueryFields,groups[1],2,firstLevelAggregateFields);}}else{groupSort=groups.sort;separateGroupFields(params,schema,references,relations,subModels,subQueries,referenceFields,subQueryFields,groups);}if(getNullOrObject(referenceFields)){params.referenceFields=referenceFields;}if(getNullOrObject(subQueryFields)){params.subQueryFields=subQueryFields;}if(getNullOrObject(groupSort)){params.groupSort=groupSort;}return params;};var separateGroupFields=function separateGroupFields(params,schema,references,relations,subModels,subQueries,referenceFields,subQueryFields,group,level,firstLevelAggregateFields){if(!group){return;}var _id=group._id,first=group.first,last=group.last,aggregates=group.aggregates,_children=group._children;if(!(_id&&(first||last||aggregates||_children))){throw new Error("Invalid group value >>> Atleast one from first, last, aggregates and _children required with _id in group>>> "+group);}var idFields={};var groupFields={};var childrenFields={};var aggregatesFields={};var simpleGroup={};if(idFields){populateGroupIdFields(_id,schema,references,{idFields:idFields});}if(first){populateGroupFields(first,"$first",schema,references,{groupFields:groupFields,referenceFields:referenceFields});}if(last){populateGroupFields(last,"$last",schema,references,{groupFields:groupFields,referenceFields:referenceFields});}if(aggregates){populateGroupAggregate(aggregates,aggregatesFields);}if(_children){var childrenReferenceFields={};var childrenSubQueryFields={};populateGroupChildrenFields(_children,params,schema,references,relations,subModels,subQueries,{childrenFields:childrenFields,referenceFields:childrenReferenceFields,subQueryFields:childrenSubQueryFields,level:level,firstLevelAggregateFields:firstLevelAggregateFields});if(getNullOrObject(childrenReferenceFields)){if(level===1){referenceFields[GROUP_BY_CHILDREN]=referenceFields[GROUP_BY_CHILDREN]||{};referenceFields[GROUP_BY_CHILDREN][GROUP_BY_CHILDREN]=childrenReferenceFields;}else if(level===2){referenceFields[GROUP_BY_CHILDREN]=referenceFields[GROUP_BY_CHILDREN]||{};_extends(referenceFields[GROUP_BY_CHILDREN],childrenReferenceFields);}else{referenceFields[GROUP_BY_CHILDREN]=childrenReferenceFields;}}if(getNullOrObject(childrenSubQueryFields)){if(level===1){subQueryFields[GROUP_BY_CHILDREN]=subQueryFields[GROUP_BY_CHILDREN]||{};subQueryFields[GROUP_BY_CHILDREN][GROUP_BY_CHILDREN]=childrenSubQueryFields;}else if(level===2){subQueryFields[GROUP_BY_CHILDREN]=subQueryFields[GROUP_BY_CHILDREN]||{};_extends(subQueryFields[GROUP_BY_CHILDREN],childrenSubQueryFields);}else{subQueryFields[GROUP_BY_CHILDREN]=childrenSubQueryFields;}}}if(level&&level===1){if(aggregates){_extends(firstLevelAggregateFields,aggregatesFields);}for(var field in _id){var fieldValue=groupFields[field];if(!fieldValue){groupFields[field]={$first:"$"+field};}}}simpleGroup={_id:_extends({},idFields)};if(getNullOrObject(groupFields)){_extends(simpleGroup,groupFields);}if(getNullOrObject(aggregatesFields)){_extends(simpleGroup,aggregatesFields);}if(getNullOrObject(childrenFields)){var child=_defineProperty({},GROUP_BY_CHILDREN,{$push:childrenFields});_extends(simpleGroup,child);}if(level===2){params.group=[params.group,simpleGroup];}else{params.group=simpleGroup;}};var populateGroupIdFields=function populateGroupIdFields(fields,schema,references,separatedFields){var idFields=separatedFields.idFields;for(var field in fields){try{var fieldSchema=schema&&schema[field];if(!fieldSchema){throw new Error("Schema not defined for field "+field);}var fieldValue=fields[field];if(fieldSchema===_rhsCommon.Primitive.date){if(isJSONObject(fieldValue)){idFields[field]=fieldValue;}else{idFields[field]="$"+field;}}else if(fieldValue===1){if(references&&references[field]){idFields[field]="$"+field+"._id";}else if(fieldValue===1){idFields[field]="$"+field;}}else{throw new Error("Invalid field value >> "+fieldValue+" of field "+field+" in group by _id fields");}}catch(e){throw new Error("Group _id field >>> "+field+" >>> Error >>>> "+e.stack);}}};var populateGroupFields=function populateGroupFields(fields,operator,schema,references,separatedFields){var groupFields=separatedFields.groupFields,referenceFields=separatedFields.referenceFields;for(var field in fields){try{var fieldSchema=schema&&schema[field];if(!fieldSchema){throw new Error("Schema not defined for field "+field);}var fieldValue=fields[field];if(fieldValue===1){groupFields[field]={};groupFields[field][operator]="$"+field;}else if(isJSONObject(fieldValue)&&references&&references[field]){groupFields[field]={};groupFields[field][operator]="$"+field;if(!fieldValue.hasOwnProperty("_id")||Object.keys(fieldValue).length>1){referenceFields[field]=fieldValue;}}else{throw new Error("Invalid field value >> "+fieldValue+" of field "+field);}}catch(e){throw new Error("Group by Field >>> "+field+" >>> Error >>>> "+e.stack);}}};var populateGroupAggregate=function populateGroupAggregate(fields,aggregatesFields){try{addAggregate(fields,aggregatesFields);}catch(e){throw new Error("Group by aggregate field Error >>>> "+e.stack);}};var populateGroupChildrenFields=function populateGroupChildrenFields(fields,params,schema,references,relations,subModels,subQueries,separatedFields){var childrenFields=separatedFields.childrenFields,referenceFields=separatedFields.referenceFields,subQueryFields=separatedFields.subQueryFields,level=separatedFields.level,firstLevelAggregateFields=separatedFields.firstLevelAggregateFields;if(fields===true&&(level===undefined||level===1)){fields=params.fields;}for(var field in fields){try{var fieldSchema=schema&&schema[field];var fieldValue=fields[field];var isAggregateField=void 0;if(firstLevelAggregateFields&&firstLevelAggregateFields[field]&&fieldValue===1){isAggregateField=true;}if(field!==GROUP_BY_CHILDREN&&!fieldSchema&&!isAggregateField){throw new Error("Schema not defined for field "+field+" level "+level);}if(subQueries&&subQueries[field]){var _relation=subQueries[field]._relation;var relationInfo=relations&&relations[_relation];if(!relationInfo){throw new Error("relation not found for field "+_relation+" defined in subQuery "+field);}subQueryFields[field]=fieldValue;}else if(fieldValue===1){childrenFields[field]="$"+field;}else if(isJSONObject(fieldValue)&&field===GROUP_BY_CHILDREN){childrenFields[field]="$"+field;}else if(isJSONObject(fieldValue)&&references&&references[field]){childrenFields[field]="$"+field;referenceFields[field]=fieldValue;}else if(isJSONObject(fieldValue)&&subModels&&subModels[field]){childrenFields[field]="$"+field;var fieldModel=subModels[field];var subModelSchema=fieldModel._schema;var subModelReferences=getReferenceFields(subModelSchema);var fieldModelRelations=getRelations(fieldModel);var fieldSubModels=getSubModels(subModelSchema);if(fieldValue===1){fieldValue={_id:1};}if(!fieldValue["_id"]){fieldValue["_id"]=1;}var subModeSeparatedFields={childrenFields:{},referenceFields:{},level:level,firstLevelAggregateFields:firstLevelAggregateFields};populateGroupChildrenFields(fieldValue,params,subModelSchema,subModelReferences,fieldModelRelations,fieldSubModels,void 0,subModeSeparatedFields);if(getNullOrObject(subModeSeparatedFields.referenceFields)){referenceFields[field]=subModeSeparatedFields.referenceFields;}}else{throw new Error("Invalid field value >> "+JSON.stringify(fieldValue)+" of field "+field+" in group children fields");}}catch(e){throw new Error("Group by children Field >>> "+field+" >>> Error >>>> "+e.stack);}}};var separateFields=function separateFields(params,schema,references,subModels,relations,subQueries,volatiles){var fields=params.fields,aggregates=params.aggregates;if(!fields||aggregates){return;}var selfFields={};var relationFields={};var referenceFields={};var subQueryFields={};var volatileFields={};populateSeparatedFields(fields,schema,references,subModels,relations,subQueries,volatiles,{selfFields:selfFields,relationFields:relationFields,referenceFields:referenceFields,subQueryFields:subQueryFields,volatileFields:volatileFields});if(getNullOrObject(selfFields)){params.fields=selfFields;}else{throw new Error("No self fields found >> fields are >>"+JSON.stringify(fields));}if(getNullOrObject(relationFields)){params.relationFields=relationFields;}if(getNullOrObject(subQueryFields)){params.subQueryFields=subQueryFields;}if(getNullOrObject(referenceFields)){params.referenceFields=referenceFields;}if(getNullOrObject(volatileFields)){params.volatileFields=volatileFields;}return params;};var populateSeparatedFields=function populateSeparatedFields(fields,schema,references,subModels,relations,subQueries,volatiles,separatedFields){var selfFields=separatedFields.selfFields,relationFields=separatedFields.relationFields,referenceFields=separatedFields.referenceFields,subQueryFields=separatedFields.subQueryFields,volatileFields=separatedFields.volatileFields;for(var field in fields){try{if(field==="__txs__"){selfFields[field]=1;continue;}var fieldSchema=schema&&schema[field];if(!fieldSchema){throw new Error("Schema not defined for field "+field);}var fieldValue=fields[field];var relationInfo=relations&&relations[field];if((0,_DBCommon.isVolatileField)(field,volatiles)){volatileFields[field]=fieldValue;}else if(subQueries&&subQueries[field]){var _relation=subQueries[field]._relation;relationInfo=relations&&relations[_relation];if(!relationInfo){throw new Error("relation not found for field "+_relation+" defined in subQuery "+field);}subQueryFields[field]=fieldValue;}else if(relationInfo){relationFields[field]=fieldValue;}else if(subModels&&subModels[field]){var fieldModel=subModels[field];var subModelSchema=fieldModel._schema;var subModelReferences=getReferenceFields(subModelSchema);var fieldModelRelations=getRelations(fieldModel);var fieldSubModels=getSubModels(subModelSchema);if(fieldValue===1){fieldValue={_id:1};}if(!fieldValue["_id"]){fieldValue["_id"]=1;}var _separateFields=separateFields({fields:fieldValue},subModelSchema,subModelReferences,fieldSubModels,fieldModelRelations),subModelFields=_separateFields.fields,subModelReferenceFields=_separateFields.referenceFields;selfFields[field]=subModelFields;if(subModelReferenceFields){referenceFields[field]=subModelReferenceFields;}}else if(isJSONObject(fieldValue)&&references&&references[field]){selfFields[field]=1;if(!fieldValue.hasOwnProperty("_id")||Object.keys(fieldValue).length>1){referenceFields[field]=fieldValue;}}else if(fieldValue===1){selfFields[field]=1;}else{throw new Error("Invalid field value "+JSON.stringify(fieldValue)+" of "+field);}if(relationInfo){var _relationInfo3=relationInfo,self=_relationInfo3.self,reference=_relationInfo3.reference,filter=_relationInfo3.filter;if(!reference&&!filter){throw new Error("Reference/Filter must be defined in relation for field >>>>>> "+field);}if(reference&&typeof reference==="string"&&reference.indexOf(".")>0){throw new Error("Dot is not allowed in reference in relation for field >>>>>> reference >>>> "+reference);}if(self){if(typeof self==="string"&&self.indexOf(".")>0){throw new Error("Dot is not allowed in self in relation for field >>>>>> self >>>> "+self);}else if(isJSONObject(self)){throw new Error("Object is not supported in self in relation for field >>>>>> self >>>> "+JSON.stringify(self));}populateSeparatedFields(_defineProperty({},self,1),schema,references,subModels,relations,subQueries,volatiles,separatedFields);}}}catch(e){throw new Error("Field >>> "+field+" >>> Error >>>> "+e.stack);}}};var findSimple=function findSimple(table,query){var filter=query.filter,fields=query.fields,group=query.group,aggregates=query.aggregates,unwind=query.unwind,sort=query.sort,groupSort=query.groupSort,limit=query.limit,skip=query.skip,modifyNativeQuery=query.modifyNativeQuery;var sortBy=sort&&isNativeSort(sort)?undefined:getNativeSort(sort);return function(db){var isAggregateQuery=aggregates||group||unwind;if(isAggregateQuery){var groupBySort=groupSort&&isNativeSort(groupSort)?undefined:getNativeSort(groupSort);group=resolveGroup({group:group,aggregates:aggregates});var pipeline=generateAggregatePipeline({filter:filter,fields:group?undefined:fields,group:group,unwind:unwind,sort:sortBy,groupSort:groupBySort,limit:limit,skip:skip});if(modifyNativeQuery&&typeof modifyNativeQuery=="function"){var modifiedPipeline=modifyNativeQuery({pipeline:pipeline});if(Array.isArray(modifiedPipeline)){pipeline=modifiedPipeline;}}return db.aggregate(table,pipeline);}else{return db.find(table,{filter:filter,fields:fields,sort:sortBy,limit:limit,skip:skip});}};};var setGlobalCache=function setGlobalCache(globalCache,cacheKey,cacheValue){if(globalCache&&cacheKey){globalCache.setCache(cacheKey,cacheValue);}};var getGlobalCache=function getGlobalCache(globalCache,cacheKey){return globalCache&&cacheKey&&globalCache.getCache(cacheKey);};var find=function find(model,query,args){if(typeof model=="function"){model=model();}var user=null;var logger=null;var globalParamValue=void 0;var globalCache=void 0;if(args){if(args._id){user=args;}else{if(args.user){user=args.user;}if(args.logger){logger=args.logger;}if(args.globalParamValue){globalParamValue=args.globalParamValue;}if(args.globalCache){globalCache=args.globalCache;}}}query=query.clone();var _query2=query,filter=_query2._filter,fields=_query2._fields,group=_query2._group,skipQueryGroupInAggregate=_query2._skipQueryGroupInAggregate,aggregates=_query2._aggregates,fieldAggregates=_query2._fieldAggregates,param=_query2._param,paramValue=_query2._paramValue,relationValue=_query2._relationValue,unwind=_query2._unwind,sort=_query2._sort,limit=_query2._limit,skip=_query2._skip,only=_query2._only,scalar=_query2._scalar,_data=_query2._data,_dataWhenNull=_query2._dataWhenNull,onResult=_query2._onResult,modifyNativeQuery=_query2._modifyNativeQuery,metadata=_query2._metadata,skipData=_query2._skipData,skipAggregates=_query2._skipAggregates,globalCacheKey=_query2._globalCacheKey;var cacheResult=getGlobalCache(globalCache,globalCacheKey);if(cacheResult){var cachePipeline=_rhsCommon.Pipeline.of("DB connect - find - Table["+table+"]").param({});cachePipeline.add(function(){return deepClone(cacheResult);});return cachePipeline;}var table=(0,_DBCommon.getTable)(model);var schema=getSchema(model);var relations=getRelations(model);var subQueries=getSubQueries(model);var subModels=getSubModels(schema);var subModelObjects=getSubModelObjects(schema);var nestedFields=getNestedFields(relations,subModels,subQueries);var references=getReferenceFields(schema,nestedFields);var volatiles=(0,_DBCommon.getVolatiles)(model);if(!fields&&!group){throw new Error("Either Fields or Group must be defined in find query >>>table>>>"+table+">>> query>>>"+JSON.stringify(query));}var endLog=logger&&logger.startLog({op:"dbConnectFind",model:model._id});var relationValuePipeline=function relationValuePipeline(params){var filter=params.filter;return _rhsCommon.Pipeline.of("relationFilter").add(function(){return getRelationFilterPipeline(params,find);},function(_){var _ref7=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},relationFilter=_ref7.relationFilter;if(relationFilter){return{filter:getMergedFilter(filter,relationFilter)};}});};var filterPipeline=function filterPipeline(params){var separateSchema={references:references,subModels:subModels,relations:relations,subQueries:subQueries,subModelObjects:subModelObjects};return modifyFilterPipeline(params,schema,separateSchema,model);};var fieldsPipeline=function fieldsPipeline(params){try{return separateFields(params,schema,references,subModels,relations,subQueries,volatiles);}catch(e){throw new Error("Error in field pipe line for model >>> "+model._id+" >>> "+e.stack);}};var groupPipeline=function groupPipeline(params){try{return separateGroups(params,schema,references,relations,subQueries,subModels,group);}catch(e){throw new Error("Error in group pipe line for model >>> "+model._id+" >>> "+e.stack);}};var nativeFind=function nativeFind(params){var fields=params.fields,filter=params.filter,group=params.group,unwind=params.unwind,groupSort=params.groupSort;if(params.hasOwnProperty("_data")){return{result:params._data};}else if(_data){return{result:_data};}return findSimple(table,{filter:filter,fields:fields,group:group,aggregates:aggregates,unwind:unwind,sort:sort,groupSort:groupSort,limit:limit,skip:skip,modifyNativeQuery:modifyNativeQuery});};var nativeFieldAggregates=function nativeFieldAggregates(_){var aggregateReferenceFields=void 0;var fieldAggregatePipeline=_rhsCommon.Pipeline.of("Db Connect - fieldAggregate");fieldAggregatePipeline.add(function(params){var filter=params.filter,aggFields=params.fieldAggregates,group=params.group,unwind=params.unwind,skipQueryGroupInAggregate=params.skipQueryGroupInAggregate;var finalGroup=void 0;var fieldAggregates=deepClone(aggFields);var firstOpFieldInAggregate=fieldAggregates["_first"];delete fieldAggregates["_first"];if(firstOpFieldInAggregate){for(var field in firstOpFieldInAggregate){var fieldValue=firstOpFieldInAggregate[field];if(isJSONObject(fieldValue)&&references&&references[field]){aggregateReferenceFields=aggregateReferenceFields||{};aggregateReferenceFields[field]=_extends({},fieldValue);fieldAggregates[field]="first";}}}if(group&&!skipQueryGroupInAggregate){var fieldAggregateGroup=resolveGroup({aggregates:fieldAggregates});finalGroup=Array.isArray(group)?[].concat(_toConsumableArray(group)):[];if(isJSONObject(group)){finalGroup.push(group);}finalGroup.push(fieldAggregateGroup);}else{finalGroup=resolveGroup({aggregates:fieldAggregates});}return findSimple(table,{filter:filter,group:finalGroup,modifyNativeQuery:modifyNativeQuery,unwind:unwind});},function(_params,aggregateResult){var fieldAggregateResult=aggregateResult.result;if(fieldAggregateResult&&Array.isArray(fieldAggregateResult)&&fieldAggregateResult.length>0){if(aggregateReferenceFields){var _pipeline=_rhsCommon.Pipeline.of("Db Connect - aggregate - joinReferenceDataPipeline").param({});joinReferenceDataPipeline({result:fieldAggregateResult,referenceFields:aggregateReferenceFields,args:args},_pipeline,schema);_pipeline.add(function(param){fieldAggregateResult=fieldAggregateResult[0];delete fieldAggregateResult._id;return{fieldAggregateResult:fieldAggregateResult};});return _pipeline;}else{fieldAggregateResult=fieldAggregateResult[0];delete fieldAggregateResult._id;return{fieldAggregateResult:fieldAggregateResult};}}});return fieldAggregatePipeline;};var relationPipeline=function relationPipeline(params){return joinRelationDataPipeline(params,schema,relations,references);};var referencePipeline=function referencePipeline(params){var rPipeline=_rhsCommon.Pipeline.of("Db Connect - joinReferenceDataPipeline").param({});return joinReferenceDataPipeline(params,rPipeline,schema,subModels);};var subQueryPipeline=function subQueryPipeline(params){try{var sPipeline=_rhsCommon.Pipeline.of("Db Connect - joinSubQueryDataPipeline").param(params);return joinSubQueryDataPipeline(params,sPipeline,schema,subQueries,relations,references);}catch(e){throw new Error("Error in subQueryPipeline model["+model._id+"] >>>> "+e.stack);}};var scalarPipeline=function scalarPipeline(params){var result=params.result;if(only){result=result.length>0?result[0]:void 0;}if(scalar){result=resolveValue(result,scalar);}return{result:result};};var sortPipeline=function sortPipeline(params){var sortBy=params.sort;if(group&&typeof group!=="string"){sortBy=params.groupSort;}if(!sortBy||!isNativeSort(sortBy)){return;}var result=params.result;if(Array.isArray(result)&&result.length>0){var _getMemorySort=getMemorySort(sortBy),_fields=_getMemorySort.fields,directions=_getMemorySort.directions;result=(0,_lodash.orderBy)(result,_fields.map(function(column){return function(row){var value=resolveValue(row,column);return isNull(value)?"":value;};}),directions);}return{result:result};};var volatilePipeline=function volatilePipeline(params){return volatileDataPipeline(params,model);};var pipeline=_rhsCommon.Pipeline.of("DB connect - find - Table["+table+"]").param({user:user,filter:filter,fields:fields,aggregates:aggregates,fieldAggregates:fieldAggregates,group:group,skipQueryGroupInAggregate:skipQueryGroupInAggregate,unwind:unwind,paramValue:paramValue,requiredParamValue:getRequiredParamValue(paramValue,param,globalParamValue),relationValue:relationValue,sort:sort,metadata:metadata,args:args});if(relationValue){pipeline.add(relationValuePipeline);}if(filter||relationValue){pipeline.add(filterPipeline);}if(group&&typeof group!=="string"){pipeline.add(groupPipeline);}else{pipeline.add(fieldsPipeline);}if(!skipData){pipeline.add(nativeFind,function(param,result){if(_dataWhenNull&&(!result||!result.result||!result.result.length)){result={result:_dataWhenNull};}return result;});}else{pipeline.add(function(){return{result:[]};});}if(!skipAggregates&&fieldAggregates){pipeline.add(nativeFieldAggregates);}pipeline.add(referencePipeline);pipeline.add(relationPipeline);pipeline.add(subQueryPipeline);pipeline.add(volatilePipeline);pipeline.add(sortPipeline);pipeline.add(scalarPipeline);pipeline.add(function(){return null;},function(param){var queryMetadata={};if(metadata){if(param.sort){queryMetadata.sort=deepClone(param.sort);}if(param.query_required){queryMetadata.query_required=true;}if(param.filter){queryMetadata.filter=deepClone(param.filter);}if(param.fields){queryMetadata.fields=deepClone(param.fields);}if(param.fieldAggregates){queryMetadata.fieldAggregates=deepClone(param.fieldAggregates);}if(param._metadata){queryMetadata._metadata=deepClone(param._metadata);if(param._subQueriesInfo){for(var _iterator3=param._subQueriesInfo,_isArray3=Array.isArray(_iterator3),_i3=0,_iterator3=_isArray3?_iterator3:_iterator3[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref8;if(_isArray3){if(_i3>=_iterator3.length)break;_ref8=_iterator3[_i3++];}else{_i3=_iterator3.next();if(_i3.done)break;_ref8=_i3.value;}var subQueryInfo=_ref8;var subQueryField=subQueryInfo.subQueryField;var subQueryId=subQueryInfo._id;var queryRequired=subQueryInfo.query_required;var subQueryFieldAggregates=subQueryInfo.fieldAggregates;var subQueryAddOnFilter=subQueryInfo._filter;var subQueryParamValue=subQueryInfo._paramValue;if(queryMetadata._metadata&&queryMetadata._metadata[subQueryField]){queryMetadata._metadata[subQueryField]=queryMetadata._metadata[subQueryField]||{};queryMetadata._metadata[subQueryField]["_id"]=subQueryId;queryMetadata._metadata[subQueryField]["query_required"]=queryRequired;if(subQueryFieldAggregates){queryMetadata._metadata[subQueryField]["fieldAggregates"]=deepClone(subQueryFieldAggregates);}if(subQueryAddOnFilter){queryMetadata._metadata[subQueryField]["addOnFilter"]=deepClone(subQueryAddOnFilter);}if(subQueryParamValue){queryMetadata._metadata[subQueryField]["_paramValue"]=deepClone(subQueryParamValue);}}}}}}var result=param.result;var fieldAggregateResult=param.fieldAggregateResult;for(var k in param){delete param[k];}var finalResult={result:result};if(fieldAggregateResult){finalResult["aggregates"]=fieldAggregateResult;}if(metadata){finalResult["_metadata"]=queryMetadata;}if(onResult&&typeof onResult=="function"){finalResult=onResult({result:finalResult});if(!isJSONObject(finalResult)){throw new Error("Query feature > onResult must return data as JSON Object but found "+JSON.stringify(finalResult));}}endLog&&endLog();setGlobalCache(globalCache,globalCacheKey,finalResult);return finalResult;});return pipeline;};module.exports={findSimple:findSimple,find:find};